easyblock = 'ConfigureMake'

name = 'FVCOM'
version = '3.2'

homepage = 'http://fvcom.smast.umassd.edu/'
description = """ Unstructured grid, Finite-Volume, primitive equation Community Ocean Model (FVCOM)
 that is well suited for simulating the circulation and ecosystem dynamics from global to estuarine
 scales, particularly for regions characterized by irregular complex coastlines, islands, inlets, creeks,
 and inter-tidal zones. """

toolchain = {'name': 'foss', 'version': '2017a'}
toolchainopts = {'f2c': True}

# Registration is needed to download the sources
sources = [SOURCELOWER_TAR_GZ]
patches = ['arch.patch', 'afteramble.patch', 'makefile_preamble.patch', 'makefile_libs.patch', 'makefile.patch']
checksums = [
    '578f3810ebfc1538699974fef75c282bd96ce931a1090e7904a533fabb26830a',  # fvcom-3.2.tar.gz
    '197c804ee21593ae20997aeae5b04de0983eb932d3386b5a531ebdf0d6590e57',  # arch.patch
    '949c84ea6cf47fdb1d01c095ec494fabb4b333e8b190376ece10a41910f39331',  # afteramble.patch
    '873546c4a7df733fc4053c06ab3a13455d16f65bf8ac820bf844631fd6863966',  # makefile_preamble.patch
    '0b3406242947a2a4a0ec2224cb1c43160027f49cd8d7bd79eac855b930ce0021',  # makefile_libs.patch
    '3b2173025709df730a2c895cab1d8ce5b4e4a205bd612ac76e53320bc65ff2a6',  # makefile.patch
]

skipsteps = ['configure', 'install']
postinstallcmds = ["cp -r %(builddir)s/FVCOM3.2.2/FVCOM_source/* %(installdir)s"]

makeopt = "TOPDIR=%(builddir)s/FVCOM3.2.2/FVCOM_source "
makeopt += "INSTALLDIR=%(builddir)s/FVCOM3.2.2/FVCOM_source/libs/install "
makeopt += "LIBDIR=-L%(builddir)s/FVCOM3.2.2/FVCOM_source/libs/install/lib "
makeopt += "INCDIR=-I%(builddir)s/FVCOM3.2.2/FVCOM_source/libs/install/include "
postmakeopt = "IOINCS=-I$EBROOTNETCDFMINFORTRAN/include " + makeopt
preopt = 'cd Configure/ && ./configure.sh series && cd ../FVCOM_source/libs && make '
preopt += makeopt + ' CPPFLAGS=; cd ../ && make depend && '

prebuildopts = [preopt]
buildopts = [postmakeopt]

dependencies = [
    ('netCDF-Fortran', '4.4.4', '', ('foss', '2017b')),
    ('METIS', '5.1.0'),
    ('makedepf90', '2.8.8', '', ('foss', '2017a'))
]

modextrapaths = {'PATH': ['']}

sanity_check_paths = {
    'files': ["fvcom"],
    'dirs': ["libs/install"]
}

moduleclass = 'bio'
